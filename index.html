<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªØ°Ø§ÙƒØ± - Ù…ØªØ¹Ø¯Ø¯ Ø§Ù„Ù…Ø­Ø§ÙƒÙ…</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
* {
margin: 0;
padding: 0;
box-sizing: border-box;
font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

body {
background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
min-height: 100vh;
padding: 20px;
direction: rtl;
}

.container {
max-width: 1400px;
margin: 0 auto;
background: white;
border-radius: 15px;
box-shadow: 0 20px 40px rgba(0,0,0,0.1);
overflow: hidden;
}

header {
background: linear-gradient(135deg, #2c3e50, #3498db);
color: white;
padding: 2rem;
text-align: center;
}

h1 {
font-size: 2.5rem;
margin-bottom: 0.5rem;
}

.subtitle {
opacity: 0.9;
font-size: 1.1rem;
}

.main-content {
padding: 2rem;
display: grid;
grid-template-columns: 1fr 1fr;
gap: 2rem;
}

@media (max-width: 768px) {
.main-content {
grid-template-columns: 1fr;
}
}

.upload-section, .validation-section {
background: #f8f9fa;
padding: 2rem;
border-radius: 10px;
border: 2px dashed #dee2e6;
}

.upload-area {
border: 3px dashed #3498db;
border-radius: 10px;
padding: 3rem 2rem;
text-align: center;
background: #ecf0f1;
cursor: pointer;
transition: all 0.3s ease;
margin-bottom: 1.5rem;
}

.upload-area:hover {
background: #d6eaf8;
border-color: #2980b9;
}

.upload-area.drag-over {
background: #d6eaf8;
border-color: #2980b9;
}

.upload-icon {
font-size: 4rem;
color: #3498db;
margin-bottom: 1rem;
}

.file-input {
display: none;
}

.btn {
background: linear-gradient(135deg, #3498db, #2980b9);
color: white;
border: none;
padding: 12px 30px;
border-radius: 25px;
font-size: 1rem;
font-weight: 600;
cursor: pointer;
transition: all 0.3s ease;
margin: 5px;
}

.btn:hover {
transform: translateY(-2px);
box-shadow: 0 5px 15px rgba(0,0,0,0.2);
}

.btn-secondary {
background: linear-gradient(135deg, #95a5a6, #7f8c8d);
}

.btn-success {
background: linear-gradient(135deg, #27ae60, #2ecc71);
}

.btn-danger {
background: linear-gradient(135deg, #e74c3c, #c0392b);
}

.validation-results {
margin-top: 2rem;
max-height: 600px;
overflow-y: auto;
}

.ticket-card {
background: white;
border-radius: 10px;
padding: 1.5rem;
margin-bottom: 1rem;
box-shadow: 0 5px 15px rgba(0,0,0,0.1);
border-left: 5px solid #3498db;
}

.ticket-card.oss-ticket {
border-left-color: #e74c3c;
}

.ticket-card.jwb-ticket {
border-left-color: #f39c12;
}

.ticket-card.eservices-ticket {
border-left-color: #9b59b6;
}

.ticket-card.workplace-ticket {
border-left-color: #1abc9c;
}

.ticket-header {
display: flex;
justify-content: space-between;
align-items: center;
margin-bottom: 1rem;
}

.ticket-title {
font-size: 1.3rem;
font-weight: bold;
color: #2c3e50;
}

.interaction-id {
background: #e74c3c;
color: white;
padding: 6px 12px;
border-radius: 20px;
font-size: 0.9rem;
font-weight: bold;
margin-top: 8px;
display: inline-block;
}

.service-badge {
background: #3498db;
color: white;
padding: 4px 8px;
border-radius: 15px;
font-size: 0.8rem;
margin-right: 8px;
}

.validation-score {
background: #3498db;
color: white;
padding: 5px 15px;
border-radius: 20px;
font-weight: bold;
}

.validation-details {
margin-top: 1rem;
}

.field-validation {
display: flex;
align-items: center;
padding: 10px;
margin: 5px 0;
border-radius: 5px;
background: #f8f9fa;
}

.validation-icon {
width: 30px;
height: 30px;
border-radius: 50%;
display: flex;
align-items: center;
justify-content: center;
margin-left: 15px;
font-weight: bold;
}

.valid {
background: #27ae60;
color: white;
}

.invalid {
background: #e74c3c;
color: white;
}

.warning {
background: #f39c12;
color: white;
}

.field-info {
flex: 1;
}

.field-name {
font-weight: bold;
color: #2c3e50;
}

.field-feedback {
color: #7f8c8d;
font-size: 0.9rem;
margin-top: 2px;
}

.suggestions {
background: #e8f4fd;
border-right: 4px solid #3498db;
padding: 1rem;
margin-top: 1rem;
border-radius: 5px;
}

.summary-stats {
display: grid;
grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
gap: 1rem;
margin-bottom: 2rem;
}

.stat-card {
background: white;
padding: 1.5rem;
border-radius: 10px;
text-align: center;
box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}

.stat-number {
font-size: 2rem;
font-weight: bold;
display: block;
}

.stat-valid { color: #27ae60; }
.stat-invalid { color: #e74c3c; }
.stat-warning { color: #f39c12; }

.loading {
text-align: center;
padding: 2rem;
}

.spinner {
border: 4px solid #f3f3f3;
border-top: 4px solid #3498db;
border-radius: 50%;
width: 40px;
height: 40px;
animation: spin 1s linear infinite;
margin: 0 auto 1rem;
}

@keyframes spin {
0% { transform: rotate(0deg); }
100% { transform: rotate(360deg); }
}

.criteria-section {
background: #fff3cd;
border-right: 4px solid #ffc107;
padding: 1rem;
margin: 1rem 0;
border-radius: 5px;
}

.criteria-list {
list-style: none;
padding-right: 0;
}

.criteria-item {
padding: 0.5rem 0;
border-bottom: 1px solid #ffeaa7;
}

.criteria-item:last-child {
border-bottom: none;
}

/* Arabic text specific styles */
.arabic-text {
font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
line-height: 1.8;
}

.field-validation {
text-align: right;
}

.legal-highlight {
background: #fff3cd;
border-right: 4px solid #ffc107;
padding: 0.5rem;
margin: 0.5rem 0;
border-radius: 3px;
}

.court-filter {
display: flex;
gap: 10px;
margin-bottom: 1rem;
flex-wrap: wrap;
}

.court-filter-btn {
padding: 8px 16px;
border: 2px solid #3498db;
background: white;
border-radius: 20px;
cursor: pointer;
transition: all 0.3s;
}

.court-filter-btn.active {
background: #3498db;
color: white;
}

.court-filter-btn:hover {
background: #2980b9;
color: white;
}

.priority-indicators {
margin: 0.5rem 0;
display: flex;
gap: 10px;
flex-wrap: wrap;
}

.duplicate-warning {
background: #fff3cd;
border-right: 4px solid #ffc107;
padding: 0.75rem;
margin: 0.5rem 0;
border-radius: 5px;
font-weight: bold;
}

.reference-highlight {
background: #d4edda;
border-right: 4px solid #28a745;
padding: 0.5rem;
margin: 0.25rem 0;
border-radius: 3px;
font-family: monospace;
}

.error-message {
background: #f8d7da;
color: #721c24;
padding: 1rem;
border-radius: 5px;
margin: 1rem 0;
text-align: center;
border-right: 4px solid #dc3545;
}

.file-info {
background: #d1ecf1;
color: #0c5460;
padding: 1rem;
border-radius: 5px;
margin: 1rem 0;
border-right: 4px solid #17a2b8;
}

.debug-info {
background: #e2e3e5;
color: #383d41;
padding: 0.5rem;
border-radius: 3px;
margin: 0.25rem 0;
font-family: monospace;
font-size: 0.8rem;
}
</style>
</head>
<body>
<div class="container">
<header>
<h1>ğŸ« Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªØ°Ø§ÙƒØ± - Ù…ØªØ¹Ø¯Ø¯ Ø§Ù„Ù…Ø­Ø§ÙƒÙ…</h1>
<p class="subtitle">Ù†Ø¸Ø§Ù… Ù…ØªÙƒØ§Ù…Ù„ Ù„Ù„ØªØ­Ù‚Ù‚ Ø§Ù„Ø¢Ù„ÙŠ Ù…Ù† Ø¬ÙˆØ¯Ø© ØªØ°Ø§ÙƒØ± Ø§Ù„Ø¯Ø¹Ù… Ø§Ù„ÙÙ†ÙŠ Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø­Ø§ÙƒÙ…</p>
</header>

<!-- Main App Content -->
<div id="mainApp">
<div class="main-content">
<div class="upload-section">
<h2>ğŸ“¤ ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù Excel Ø£Ùˆ CSV</h2>
<p>Ù‚Ù… Ø¨ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù Excel Ø£Ùˆ CSV Ø§Ù„Ø°ÙŠ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø§Ù„ØªØ°Ø§ÙƒØ± Ø¨Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„ØªØ§Ù„ÙŠØ©:</p>
<ul style="margin: 1rem 0; padding-right: 2rem;">
<li><strong>Affected Service</strong> (CMS - SJC, OSS - SJC, E-Services - SJC, JWB - SJC, Workplace Services - SJC)</li>
<li><strong>Description</strong> (Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© - ÙŠØ¬Ø¨ Ø£Ù† ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø±Ù‚Ù… Ø§Ù„Ø¯Ø¹ÙˆÙ‰/Ø§Ù„Ø·Ù„Ø¨)</li>
<li><strong>Closure Code</strong> (Case Amended, Information Provided, Reports, Application, Duplicate Ticket, etc.)</li>
<li><strong>Title</strong> (Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© - 4-6 ÙƒÙ„Ù…Ø§Øª ÙƒØ­Ø¯ Ø£Ù‚ØµÙ‰)</li>
<li><strong>Category</strong> (Ø¨Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©)</li>
<li><strong>Subcategory</strong> (Ø¨Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©)</li>
<li><strong>Classification</strong> (Ø¨Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©)</li>
<li><strong>Resolution Method</strong> (Ø¨Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©)</li>
<li><strong>Solution</strong> (Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© - ÙŠØ¬Ø¨ Ø£Ù† ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¥Ø´Ø§Ø±Ø© Ù„Ù„Ø¥Ù†Ø¬Ø§Ø²)</li>
<li><strong>Interaction ID</strong> (Ø±Ù‚Ù… Ø§Ù„ØªØ°ÙƒØ±Ø© - Ù…Ø«Ù„ SD1664592)</li>
</ul>

<div class="upload-area" id="uploadArea">
<div class="upload-icon">ğŸ“Š</div>
<h3>Ø§Ø³Ø­Ø¨ Ù…Ù„Ù Excel Ø£Ùˆ CSV Ù‡Ù†Ø§</h3>
<p>Ø£Ùˆ Ø§Ù†Ù‚Ø± Ù„Ù„ØªØµÙØ­ (ÙŠØ¯Ø¹Ù… Excel Ùˆ CSV)</p>
<input type="file" id="fileInput" class="file-input" accept=".xlsx, .xls, .csv, .txt">
</div>

<div id="fileInfo" class="file-info" style="display: none;">
<strong>Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ù„Ù:</strong>
<div id="fileDetails"></div>
</div>

<div id="uploadError" class="error-message" style="display: none;">
<!-- Error messages will appear here -->
</div>

<div class="criteria-section">
<h4>ğŸ” Ù…Ø¹Ø§ÙŠÙŠØ± Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„Ù…Ø­Ø³Ù†Ø©</h4>
<ul class="criteria-list">
<li class="criteria-item"><strong>Ø§Ù„ÙˆØµÙ:</strong> ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø±Ù‚Ù… Ø§Ù„Ø¯Ø¹ÙˆÙ‰/Ø§Ù„Ø·Ù„Ø¨ (Ù…Ø«Ø§Ù„: 14166/2025/Ø¬Ù†Ø­Ø©/Ø§Ø³ØªØ¦Ù†Ø§Ù)</li>
<li class="criteria-item"><strong>Ø§Ù„Ø­Ù„:</strong> ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙˆØ¶Ø­ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„Ù…Ù„Ù…ÙˆØ³ ÙˆÙ„ÙŠØ³ Ù…Ø¬Ø±Ø¯ ØªÙˆØ¬ÙŠÙ‡</li>
<li class="criteria-item"><strong>Ø§Ù„ÙØ¦Ø© ÙˆØ§Ù„ØªØµÙ†ÙŠÙ:</strong> ÙŠØ¬Ø¨ Ø£Ù† ØªØªØ·Ø§Ø¨Ù‚ Ù…Ø¹ Ù†ÙˆØ¹ Ø§Ù„Ø®Ø¯Ù…Ø© Ø§Ù„Ù…ØªØ£Ø«Ø±Ø©</li>
<li class="criteria-item"><strong>ÙƒÙˆØ¯ Ø§Ù„Ø¥ØºÙ„Ø§Ù‚:</strong> ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ù…Ù†Ø§Ø³Ø¨Ø§Ù‹ Ù„Ù†ÙˆØ¹ Ø§Ù„Ø®Ø¯Ù…Ø©</li>
<li class="criteria-item"><strong>Ø§Ù„ØªÙƒØ±Ø§Ø±:</strong> Ø§Ù„ÙƒØ´Ù Ø¹Ù† Ø§Ù„ØªØ°Ø§ÙƒØ± Ø§Ù„Ù…ÙƒØ±Ø±Ø©</li>
<li class="criteria-item"><strong>Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹:</strong> Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø¯Ø¹Ø§ÙˆÙ‰ ÙˆØ§Ù„Ø·Ù„Ø¨Ø§Øª</li>
</ul>
</div>

<button class="btn" onclick="document.getElementById('fileInput').click()">
Ø§Ø®ØªØ± Ù…Ù„Ù
</button>
<button class="btn btn-secondary" onclick="validateSampleData()">
ØªØ¬Ø±Ø¨Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ù…ÙˆØ°Ø¬ÙŠØ©
</button>
<button class="btn btn-success" onclick="exportResults()" id="exportBtn" style="display: none;">
ØªØµØ¯ÙŠØ± Ø§Ù„Ù†ØªØ§Ø¦Ø¬
</button>
<button class="btn btn-danger" onclick="clearResults()" id="clearBtn" style="display: none;">
Ù…Ø³Ø­ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
</button>
</div>

<div class="validation-section">
<h2>ğŸ“‹ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„ØªØ­Ù‚Ù‚</h2>

<div class="court-filter" id="courtFilter">
<button class="court-filter-btn active" onclick="filterTicketsByCourt('all')">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø­Ø§ÙƒÙ…</button>
<button class="court-filter-btn" onclick="filterTicketsByCourt('CMS')">Ù…Ø­Ø§ÙƒÙ… Ø§Ù„Ø£Ø³Ø±Ø© (CMS)</button>
<button class="court-filter-btn" onclick="filterTicketsByCourt('OSS')">Ø§Ù„Ø®Ø¯Ù…Ø© Ø§Ù„Ù…ÙˆØ­Ø¯Ø© (OSS)</button>
<button class="court-filter-btn" onclick="filterTicketsByCourt('JWB')">Ù…Ù†ØµØ© Ø§Ù„Ù‚Ø¶Ø§Ø© (JWB)</button>
<button class="court-filter-btn" onclick="filterTicketsByCourt('E-Services')">Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ©</button>
<button class="court-filter-btn" onclick="filterTicketsByCourt('Workplace')">Ø®Ø¯Ù…Ø§Øª Ù…ÙƒØ§Ù† Ø§Ù„Ø¹Ù…Ù„</button>
</div>

<div id="summaryStats" class="summary-stats">
<div class="stat-card">
<span class="stat-number stat-valid" id="validCount">0</span>
<span>ØªØ°Ø§ÙƒØ± ØµØ§Ù„Ø­Ø©</span>
</div>
<div class="stat-card">
<span class="stat-number stat-warning" id="warningCount">0</span>
<span>ØªØ­Ø°ÙŠØ±Ø§Øª</span>
</div>
<div class="stat-card">
<span class="stat-number stat-invalid" id="invalidCount">0</span>
<span>ØªØ°Ø§ÙƒØ± ØºÙŠØ± ØµØ§Ù„Ø­Ø©</span>
</div>
<div class="stat-card">
<span class="stat-number" id="totalCount" style="color: #3498db;">0</span>
<span>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªØ°Ø§ÙƒØ±</span>
</div>
</div>

<div id="validationResults" class="validation-results">
<div class="loading" id="loadingIndicator" style="display: none;">
<div class="spinner"></div>
<p>Ø¬Ø§Ø±ÙŠ ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØªØ°Ø§ÙƒØ±...</p>
</div>
<div id="resultsContainer">
<p style="text-align: center; color: #7f8c8d; padding: 2rem;">
Ù‚Ù… Ø¨ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù Excel Ø£Ùˆ CSV Ù„Ø±Ø¤ÙŠØ© Ù†ØªØ§Ø¦Ø¬ Ø§Ù„ØªØ­Ù‚Ù‚
</p>
</div>
</div>
</div>
</div>
</div>
</div>

<script>
// Enhanced validation rules for multiple courts based on actual CSV analysis
let validationRules = {
title: {
maxWords: 6,
minLength: 5,
maxLength: 80,
shouldNotContain: ['Ø§Ø®ØªØ¨Ø§Ø±', 'Ù…Ø¤Ù‚Øª', 'Ù…Ø³ÙˆØ¯Ø©', 'ÙŠØ±Ø¬Ù‰', 'Ø§Ù„ØªÙƒØ±Ù…'],
requiredKeywords: ['Ø·Ù„Ø¨', 'Ù…Ø´ÙƒÙ„Ø©', 'Ø¥Ø¶Ø§ÙØ©', 'ØªØ¹Ø¯ÙŠÙ„', 'Ø¥ØºÙ„Ø§Ù‚', 'ØµÙ„Ø§Ø­ÙŠØ©', 'ØªØ­Ù‚Ù‚', 'ØªØ¯Ù‚ÙŠÙ‚', 'Ø¨Ù„Ø§Øº', 'Ø¯Ø¹ÙˆÙ‰']
},
description: {
minLength: 15,
requiredElements: ['Ø±Ù‚Ù…', 'Ø¯Ø¹ÙˆÙ‰', 'Ø·Ù„Ø¨', 'Ø¨Ù„Ø§Øº'],
mustContainReference: true,
referencePatterns: [
/\d+\/\d+\/\w+\/\w+/, // Pattern for case numbers: 14166/2025/Ø¬Ù†Ø­Ø©/Ø§Ø³ØªØ¦Ù†Ø§Ù
/SD\d+/, // Interaction ID pattern
/Ø±Ù‚Ù…\s+(Ø§Ù„Ø¯Ø¹ÙˆÙ‰|Ø§Ù„Ø·Ù„Ø¨|Ø§Ù„Ø¨Ù„Ø§Øº)\s*[\d\/\w]+/,
/\d{4}\/\d+\/\w+\/\w+/ // Another case number pattern
]
},
solution: {
minLength: 20,
requiredElements: ['ØªÙ…', 'Ø¥Ø¶Ø§ÙØ©', 'ØªØ¹Ø¯ÙŠÙ„', 'Ø¥ØºÙ„Ø§Ù‚', 'ØªØ­Ù‚Ù‚', 'ØªØ­Ø¯ÙŠØ«'],
actionWords: ['ØªÙ…', 'ØªÙ…Øª', 'Ø§Ù†ØªÙ‡Ù‰', 'Ø£ÙƒÙ…Ù„', 'Ø£Ù†Ù‡Ù‰', 'Ù†ÙØ°', 'Ø£Ù†Ø¬Ø²', 'ØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚', 'ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«', 'ØªÙ… Ø§Ù„Ø¥ØµÙ„Ø§Ø­', 'ØªÙ… Ø§Ù„Ø­Ù„'],
mustShowAction: true,
forbiddenPhrases: ['ØªÙ… Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ ÙÙ‚Ø·', 'ÙŠØ¬Ø¨ Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹', 'Ø­Ø³Ø¨ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨', 'ÙŠØ¬Ø¨ Ø§Ø±Ø³Ø§Ù„ Ø§ÙŠÙ…ÙŠÙ„']
},

// Enhanced service-specific rules based on actual data
affectedService: {
validServices: ['CMS - SJC', 'OSS - SJC', 'E-Services - SJC', 'JWB - SJC', 'Workplace Services - SJC'],
courtMapping: {
'CMS - SJC': 'CMS',
'OSS - SJC': 'OSS',
'E-Services - SJC': 'E-Services',
'JWB - SJC': 'JWB',
'Workplace Services - SJC': 'Workplace'
},
serviceExpectations: {
'CMS - SJC': {
commonCategories: ['CMS - Cases', 'CMS - Requests', 'CMS - Access', 'CMS - Court Rooms', 'CMS - Case Management'],
commonClosures: ['Application', 'Case Amended', 'Reports', 'Duplicate Ticket']
},
'OSS - SJC': {
commonCategories: ['CMS - Requests', 'Functional Support', 'CMS - Cases'],
commonClosures: ['Information Provided', 'Application', 'Duplicate Ticket']
},
'JWB - SJC': {
commonCategories: ['JWB - SJC', 'Functional Support'],
commonClosures: ['Information Provided', 'Application']
},
'E-Services - SJC': {
commonCategories: ['E-Services - SJC', 'Functional Support'],
commonClosures: ['Information Provided', 'Application']
},
'Workplace Services - SJC': {
commonCategories: ['Functional Support', 'CMS - Cases'],
commonClosures: ['Application', 'Information Provided']
}
}
},

// Enhanced closure code validation
closureCode: {
validCodes: [
'Case Amended', 'Information Provided', 'Reports', 'Application',
'Duplicate Ticket', 'Functional Low', 'Functional High', 'No action taken/required',
'Decision Amended', 'User Training', 'Request Amended'
],
// More specific service-closure mapping
serviceSpecific: {
'CMS - SJC': ['Case Amended', 'Application', 'Reports', 'Duplicate Ticket'],
'OSS - SJC': ['Information Provided', 'Application', 'Duplicate Ticket'],
'E-Services - SJC': ['Information Provided', 'Application'],
'JWB - SJC': ['Information Provided', 'Application', 'Decision Amended'],
'Workplace Services - SJC': ['Application', 'Information Provided']
}
},

// FIXED: Added resolutionMethod validation rules
resolutionMethod: {
validMethods: [
'Remote resolution', 'Site Visit', 'Remote Resolution - BOMGAR / Teamviewer',
'Client Resolved', 'Remote Resolution - Phone', 'On-site support'
]
},

// Enhanced category validation based on actual data analysis
categories: {
main: [
'CMS - Cases', 'CMS - Requests', 'CMS - Access', 'CMS - Court Rooms',
'Functional Support', 'CMS - Case Management', 'Data Cleansing',
'OSS - SJC', 'JWB - SJC', 'E-Services - SJC'
],
serviceMapping: {
'CMS - SJC': ['CMS - Cases', 'CMS - Requests', 'CMS - Access', 'CMS - Court Rooms', 'CMS - Case Management', 'Data Cleansing'],
'OSS - SJC': ['Functional Support', 'CMS - Requests', 'CMS - Cases'],
'JWB - SJC': ['JWB - SJC', 'Functional Support'],
'E-Services - SJC': ['E-Services - SJC', 'Functional Support'],
'Workplace Services - SJC': ['Functional Support', 'CMS - Cases']
},
// Updated subcategories based on actual CSV data
subcategories: {
'CMS - Cases': ['Case Status', 'Panel Details', 'Case Details', 'Hearings', 'Attachments', 'Case Related Case', 'technical issue'],
'CMS - Requests': ['Request Status', 'Attachments', 'Payments Details'],
'CMS - Access': ['User Access', 'Grant/Revoke Access'],
'CMS - Court Rooms': ['Panel Team', 'Panel Details'],
'Functional Support': ['CMS Application', 'Request for Information'],
'CMS - Case Management': ['FS Team Tasks', 'Summary Report', 'Investigation', 'Parties'],
'Data Cleansing': ['CMS', 'Edit Request'],
'OSS - SJC': ['Request Status', 'technical issue'],
'JWB - SJC': ['Request Status', 'Judge Workbench'],
'E-Services - SJC': ['Request Status', 'Portal Issues']
}
},

// Updated classifications based on actual data
classifications: [
'add case subject', 'change case status', 'add related case', 'Change Panel',
'amend request status', 'Grant/Revoke Access', 'Request for Information',
'error message', 'unable to add related case', 'Change Attachment type',
'Help user', 'Edit Request', 'amend hearing session type', 'RFI',
'Investigation', 'add panel member', 'delete panel member', 'amend hearing session status',
'Hearing session not created', 'Summary Report', 'FS Team Tasks'
]
};

// Global variables
let currentValidationResults = [];
let filteredResults = [];

// Enhanced validation functions for multiple courts
function validateSingleTicket(ticket) {
try {
// Safe data extraction with fallbacks
const ticketData = {
title: ticket.Title || ticket.title || '',
description: ticket.Description || ticket.description || '',
solution: ticket.Solution || ticket.solution || '',
category: ticket.Category || ticket.category || '',
subcategory: ticket.Subcategory || ticket.subcategory || '',
classification: ticket.Classification || ticket.classification || '',
affectedService: ticket['Affected Service'] || ticket.affectedService || '',
closureCode: ticket['Closure Code'] || ticket.closureCode || '',
resolutionMethod: ticket['Resolution Method'] || ticket.resolutionMethod || '',
interactionId: ticket['Interaction ID'] || ticket['Interaction_ID'] || ticket.interactionId || ''
};

console.log('Processing ticket:', ticketData);

const validations = {
title: validateTitle(ticketData.title),
description: validateDescription(ticketData.description),
solution: validateSolution(ticketData.solution),
category: validateCategory(ticketData.category, ticketData.affectedService),
subcategory: validateSubcategory(ticketData.category, ticketData.subcategory),
classification: validateClassification(ticketData.classification),
affectedService: validateAffectedService(ticketData.affectedService),
closureCode: validateClosureCode(ticketData.closureCode, ticketData.affectedService),
resolutionMethod: validateResolutionMethod(ticketData.resolutionMethod),
interactionId: validateInteractionId(ticketData.interactionId)
};

const totalFields = Object.keys(validations).length;
const validFields = Object.values(validations).filter(v => v && v.isValid).length;
const warningFields = Object.values(validations).filter(v => v && v.hasWarning).length;

const score = totalFields > 0 ? Math.round((validFields / totalFields) * 100) : 0;

// Determine court type for filtering
const courtType = validationRules.affectedService.courtMapping[ticketData.affectedService] || 'Other';

return {
ticket: ticketData,
validations,
score,
courtType: courtType,
isValid: score >= 70,
hasWarnings: warningFields > 0
};
} catch (error) {
console.error('Error validating ticket:', ticket, error);
return {
ticket: ticket,
validations: {},
score: 0,
courtType: 'Error',
isValid: false,
hasWarnings: false,
error: error.message
};
}
}

function validateAffectedService(service) {
const result = { isValid: true, hasWarning: false, feedback: [] };

if (!service) {
result.isValid = false;
result.feedback.push('Ø§Ù„Ø®Ø¯Ù…Ø© Ø§Ù„Ù…ØªØ£Ø«Ø±Ø© Ù…Ø·Ù„ÙˆØ¨Ø©');
return result;
}

if (!validationRules.affectedService.validServices.includes(service)) {
result.isValid = false;
result.feedback.push(`Ø®Ø¯Ù…Ø© ØºÙŠØ± ØµØ§Ù„Ø­Ø©. Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª: ${validationRules.affectedService.validServices.join(', ')}`);
} else {
result.feedback.push(`Ø§Ù„Ø®Ø¯Ù…Ø© Ø§Ù„Ù…ØªØ£Ø«Ø±Ø© ØµØ­ÙŠØ­Ø© (${service})`);
}

return result;
}

function validateClosureCode(closureCode, affectedService) {
const result = { isValid: true, hasWarning: false, feedback: [] };

if (!closureCode) {
result.isValid = false;
result.feedback.push('ÙƒÙˆØ¯ Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ Ù…Ø·Ù„ÙˆØ¨');
return result;
}

if (!validationRules.closureCode.validCodes.includes(closureCode)) {
result.isValid = false;
result.feedback.push(`ÙƒÙˆØ¯ Ø¥ØºÙ„Ø§Ù‚ ØºÙŠØ± ØµØ§Ù„Ø­. Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª: ${validationRules.closureCode.validCodes.join(', ')}`);
return result;
}

// Check if closure code is appropriate for the service
const serviceCodes = validationRules.closureCode.serviceSpecific[affectedService];
if (serviceCodes && !serviceCodes.includes(closureCode)) {
result.hasWarning = true;
result.feedback.push(`ÙƒÙˆØ¯ Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ "${closureCode}" ØºÙŠØ± Ù…Ø¹ØªØ§Ø¯ Ù„Ù„Ø®Ø¯Ù…Ø© "${affectedService}"`);
} else {
result.feedback.push('ÙƒÙˆØ¯ Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ Ù…Ù†Ø§Ø³Ø¨ Ù„Ù„Ø®Ø¯Ù…Ø©');
}

return result;
}

function validateCategory(category, affectedService) {
const result = { isValid: true, hasWarning: false, feedback: [] };

if (!category) {
result.isValid = false;
result.feedback.push('Ø§Ù„ÙØ¦Ø© Ù…Ø·Ù„ÙˆØ¨Ø©');
return result;
}

if (!validationRules.categories.main.includes(category)) {
result.isValid = false;
result.feedback.push(`ÙØ¦Ø© ØºÙŠØ± ØµØ§Ù„Ø­Ø©: "${category}"`);
return result;
}

// Check if category matches the affected service
const serviceCategories = validationRules.categories.serviceMapping[affectedService];
if (serviceCategories && !serviceCategories.includes(category)) {
result.hasWarning = true;
result.feedback.push(`Ø§Ù„ÙØ¦Ø© "${category}" ØºÙŠØ± Ù…Ø¹ØªØ§Ø¯Ø© Ù„Ù„Ø®Ø¯Ù…Ø© "${affectedService}"`);
} else {
result.feedback.push(`Ø§Ù„ÙØ¦Ø© Ù…Ù†Ø§Ø³Ø¨Ø© Ù„Ù„Ø®Ø¯Ù…Ø©`);
}

return result;
}

function validateSubcategory(category, subcategory) {
const result = { isValid: true, hasWarning: false, feedback: [] };

if (!subcategory) {
result.isValid = false;
result.feedback.push('Ø§Ù„ÙØ¦Ø© Ø§Ù„ÙØ±Ø¹ÙŠØ© Ù…Ø·Ù„ÙˆØ¨Ø©');
return result;
}

const validSubcategories = validationRules.categories.subcategories[category];
if (!validSubcategories || !validSubcategories.includes(subcategory)) {
result.isValid = false;
result.feedback.push(`ÙØ¦Ø© ÙØ±Ø¹ÙŠØ© ØºÙŠØ± ØµØ§Ù„Ø­Ø© Ù„Ù€ "${category}"`);
} else {
result.feedback.push('Ø§Ù„ÙØ¦Ø© Ø§Ù„ÙØ±Ø¹ÙŠØ© ØªØ·Ø§Ø¨Ù‚ Ø§Ù„ÙØ¦Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©');
}

return result;
}

function validateResolutionMethod(method) {
const result = { isValid: true, hasWarning: false, feedback: [] };

if (!method) {
result.isValid = false;
result.feedback.push('Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø­Ù„ Ù…Ø·Ù„ÙˆØ¨Ø©');
return result;
}

// FIXED: Added safe access to resolutionMethod rules
const validMethods = validationRules.resolutionMethod?.validMethods || [];
if (validMethods.length === 0) {
result.hasWarning = true;
result.feedback.push('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ø±Ù‚ Ø­Ù„ Ù…Ø¹ØªÙ…Ø¯Ø© Ù…Ø­Ø¯Ø¯Ø© ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…');
} else if (!validMethods.includes(method)) {
result.hasWarning = true;
result.feedback.push(`Ø·Ø±ÙŠÙ‚Ø© Ø­Ù„ ØºÙŠØ± Ù…Ø¹ØªÙ…Ø¯Ø©. Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ù…ÙˆØµÙ‰ Ø¨Ù‡Ø§: ${validMethods.join(', ')}`);
} else {
result.feedback.push('Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø­Ù„ Ù…Ù†Ø§Ø³Ø¨Ø©');
}

return result;
}

function validateInteractionId(interactionId) {
const result = { isValid: true, hasWarning: false, feedback: [] };

if (!interactionId) {
result.isValid = false;
result.feedback.push('Ø±Ù‚Ù… Ø§Ù„ØªØ°ÙƒØ±Ø© (Interaction ID) Ù…Ø·Ù„ÙˆØ¨');
return result;
}

const interactionIdPattern = /^SD\d+$/;
if (!interactionIdPattern.test(interactionId)) {
result.hasWarning = true;
result.feedback.push('Ø±Ù‚Ù… Ø§Ù„ØªØ°ÙƒØ±Ø© ÙŠØ¬Ø¨ Ø£Ù† ÙŠØªØ¨Ø¹ Ø§Ù„ØªÙ†Ø³ÙŠÙ‚ SD Ù…ØªØ¨ÙˆØ¹Ø§Ù‹ Ø¨Ø£Ø±Ù‚Ø§Ù…');
} else {
result.feedback.push('Ø±Ù‚Ù… Ø§Ù„ØªØ°ÙƒØ±Ø© ØµØ­ÙŠØ­');
}

return result;
}

// Enhanced validation functions
function countWords(text) {
if (!text) return 0;
return text.trim().split(/[\s\u0600-\u06FF,.;:!?]+/).filter(word => word.length > 0).length;
}

function validateTitle(title) {
const result = { isValid: true, hasWarning: false, feedback: [] };

if (!title) {
result.isValid = false;
result.feedback.push('Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ù…Ø·Ù„ÙˆØ¨');
return result;
}

const wordCount = countWords(title);

if (wordCount > validationRules.title.maxWords) {
result.isValid = false;
result.feedback.push(`Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø·ÙˆÙŠÙ„ Ø¬Ø¯Ø§Ù‹ (Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ ${validationRules.title.maxWords} ÙƒÙ„Ù…Ø§Øª)`);
}

if (title.length < validationRules.title.minLength) {
result.isValid = false;
result.feedback.push(`Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ù‚ØµÙŠØ± Ø¬Ø¯Ø§Ù‹ (Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ ${validationRules.title.minLength} Ø­Ø±Ù)`);
}

const hasKeyword = validationRules.title.requiredKeywords.some(keyword =>
title.includes(keyword)
);

if (!hasKeyword) {
result.hasWarning = true;
result.feedback.push(`ÙŠÙØ¶Ù„ Ø¥Ø¶Ø§ÙØ© ÙƒÙ„Ù…Ø§Øª Ù…ÙØªØ§Ø­ÙŠØ© Ù…Ù†Ø§Ø³Ø¨Ø©`);
}

if (result.feedback.length === 0) {
result.feedback.push('Ø§Ù„Ø¹Ù†ÙˆØ§Ù† ÙŠÙ„Ø¨ÙŠ Ø§Ù„Ù…ØªØ·Ù„Ø¨Ø§Øª');
}

return result;
}

function validateDescription(description) {
const result = { isValid: true, hasWarning: false, feedback: [] };

if (!description || description.length < validationRules.description.minLength) {
result.isValid = false;
result.feedback.push(`Ø§Ù„ÙˆØµÙ Ù‚ØµÙŠØ± Ø¬Ø¯Ø§Ù‹ (Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ ${validationRules.description.minLength} Ø­Ø±Ù)`);
return result;
}

// Check for case/request numbers using patterns
const hasReference = validationRules.description.referencePatterns.some(pattern =>
pattern.test(description)
);

if (!hasReference) {
result.isValid = false;
result.feedback.push('ÙŠØ¬Ø¨ Ø°ÙƒØ± Ø±Ù‚Ù… Ø§Ù„Ø¯Ø¹ÙˆÙ‰ Ø£Ùˆ Ø§Ù„Ø·Ù„Ø¨ Ø£Ùˆ Ø§Ù„Ø¨Ù„Ø§Øº ÙÙŠ Ø§Ù„ÙˆØµÙ (Ù…Ø«Ø§Ù„: 14166/2025/Ø¬Ù†Ø­Ø©/Ø§Ø³ØªØ¦Ù†Ø§Ù)');
}

// Check if description is just copied email (contains greetings)
const isEmailCopy = description.includes('Ø§Ù„ØªØ­ÙŠØ© ÙˆØ§Ù„ØªÙ‚Ø¯ÙŠØ±') ||
description.includes('ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªÙƒØ±Ù…') ||
description.includes('Ù…Ø¹ Ø®Ø§Ù„Øµ Ø§Ù„Ø´ÙƒØ±');

if (isEmailCopy) {
result.hasWarning = true;
result.feedback.push('Ø§Ù„ÙˆØµÙ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ ØµÙŠØº Ø®Ø·Ø§Ø¨ÙŠØ© - ÙŠÙØ¶Ù„ ØµÙŠØ§ØºØ© Ø§Ù„ÙˆØµÙ Ø¨Ø´ÙƒÙ„ ØªÙ‚Ù†ÙŠ Ù…Ø¨Ø§Ø´Ø±');
}

if (result.feedback.length === 0) {
result.feedback.push('Ø§Ù„ÙˆØµÙ Ø´Ø§Ù…Ù„ ÙˆÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©');
}

return result;
}

function validateSolution(solution) {
const result = { isValid: true, hasWarning: false, feedback: [] };

if (!solution || solution.length < validationRules.solution.minLength) {
result.isValid = false;
result.feedback.push(`Ø§Ù„Ø­Ù„ Ù…Ø®ØªØµØ± Ø¬Ø¯Ø§Ù‹ (Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ ${validationRules.solution.minLength} Ø­Ø±Ù)`);
return result;
}

// Check for action words
const hasActionWord = validationRules.solution.actionWords.some(word =>
solution.includes(word)
);

if (!hasActionWord) {
result.isValid = false;
result.feedback.push('Ø§Ù„Ø­Ù„ ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¥Ø´Ø§Ø±Ø© Ù„Ù„Ø¥Ù†Ø¬Ø§Ø² (ØªÙ…ØŒ ØªÙ…ØªØŒ Ø¥Ù„Ø®)');
}

// Check for weak solutions
const hasForbiddenPhrase = validationRules.solution.forbiddenPhrases.some(phrase =>
solution.includes(phrase)
);

if (hasForbiddenPhrase) {
result.hasWarning = true;
result.feedback.push('Ø§Ù„Ø­Ù„ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¹Ø¨Ø§Ø±Ø§Øª ØºÙŠØ± ÙØ¹Ø§Ù„Ø© (ÙŠØ¬Ø¨ ØªÙˆØ¶ÙŠØ­ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„Ù…Ù„Ù…ÙˆØ³)');
}

// Check if solution shows what was actually done
const hasSpecificAction = solution.includes('ØªÙ… Ø¥Ø¶Ø§ÙØ©') ||
solution.includes('ØªÙ… ØªØ¹Ø¯ÙŠÙ„') ||
solution.includes('ØªÙ… Ø¥ØºÙ„Ø§Ù‚') ||
solution.includes('ØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚');

if (!hasSpecificAction) {
result.hasWarning = true;
result.feedback.push('ÙŠÙØ¶Ù„ ØªÙˆØ¶ÙŠØ­ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„Ù…Ø­Ø¯Ø¯ Ø§Ù„Ø°ÙŠ ØªÙ… ØªÙ†ÙÙŠØ°Ù‡');
}

if (result.feedback.length === 0) {
result.feedback.push('Ø§Ù„Ø­Ù„ ÙˆØ§Ø¶Ø­ ÙˆÙŠÙˆØ¶Ø­ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ ÙˆØ§Ù„Ù†ØªÙŠØ¬Ø©');
}

return result;
}

function validateClassification(classification) {
const result = { isValid: true, hasWarning: false, feedback: [] };

if (!classification) {
result.isValid = false;
result.feedback.push('Ø§Ù„ØªØµÙ†ÙŠÙ Ù…Ø·Ù„ÙˆØ¨');
return result;
}

if (!validationRules.classifications.includes(classification)) {
result.isValid = false;
result.feedback.push(`ØªØµÙ†ÙŠÙ ØºÙŠØ± ØµØ§Ù„Ø­`);
} else {
result.feedback.push('Ø§Ù„ØªØµÙ†ÙŠÙ Ù…Ù†Ø§Ø³Ø¨');
}

return result;
}

// Duplicate detection function
function detectPotentialDuplicates(tickets) {
const duplicates = [];
const titleMap = new Map();

tickets.forEach((ticket, index) => {
const title = ticket.Title || ticket.title || '';
const simpleTitle = title.replace(/[^Ø£-ÙŠa-z0-9]/gi, '').toLowerCase();
if (titleMap.has(simpleTitle) && simpleTitle.length > 3) {
duplicates.push({
ticket1: titleMap.get(simpleTitle),
ticket2: index,
title: title
});
} else {
titleMap.set(simpleTitle, index);
}
});

return duplicates;
}

// File processing functions with better error handling
function handleFileUpload(event) {
const file = event.target.files[0];
if (!file) return;

// Reset previous results
clearError();
hideFileInfo();

const loadingIndicator = document.getElementById('loadingIndicator');
loadingIndicator.style.display = 'block';

// Show file info
showFileInfo(file);

setTimeout(() => {
processExcelFile(file);
loadingIndicator.style.display = 'none';
}, 500);
}

function processExcelFile(file) {
const reader = new FileReader();

reader.onload = function(e) {
try {
const data = new Uint8Array(e.target.result);
let workbook;

if (file.name.endsWith('.csv')) {
const csvData = new TextDecoder().decode(data);
workbook = XLSX.read(csvData, { type: 'string', raw: true });
} else {
workbook = XLSX.read(data, { type: 'array' });
}

console.log('Workbook sheets:', workbook.SheetNames);

const worksheet = workbook.Sheets[workbook.SheetNames[0]];
const jsonData = XLSX.utils.sheet_to_json(worksheet);

console.log('Parsed data:', jsonData);

if (jsonData.length === 0) {
showError('Ø§Ù„Ù…Ù„Ù Ù„Ø§ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø£Ùˆ ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù…Ù„Ù ØºÙŠØ± ØµØ­ÙŠØ­');
return;
}

// Show column names for debugging
const firstRow = jsonData[0];
console.log('Column names:', Object.keys(firstRow));
showDebugInfo('Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ù…ÙƒØªØ´ÙØ©: ' + Object.keys(firstRow).join(', '));

validateTickets(jsonData);
} catch (error) {
console.error('Error processing file:', error);
showError('Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…Ù„Ù: ' + error.message);
}
};

reader.onerror = function() {
showError('Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù');
};

if (file.name.endsWith('.csv')) {
reader.readAsArrayBuffer(file);
} else {
reader.readAsArrayBuffer(file);
}
}

function validateTickets(tickets) {
try {
console.log('Starting validation of', tickets.length, 'tickets');

const validationResults = tickets.map(ticket => validateSingleTicket(ticket));

// Detect duplicates
const duplicates = detectPotentialDuplicates(tickets);
if (duplicates.length > 0) {
console.log('Potential duplicates found:', duplicates);
// Mark duplicates in results
duplicates.forEach(dup => {
if (validationResults[dup.ticket1]) validationResults[dup.ticket1].isDuplicate = true;
if (validationResults[dup.ticket2]) validationResults[dup.ticket2].isDuplicate = true;
});
}

currentValidationResults = validationResults;
filteredResults = validationResults;
displayResults(validationResults);
updateSummaryStats(validationResults);

document.getElementById('exportBtn').style.display = 'inline-block';
document.getElementById('clearBtn').style.display = 'inline-block';

console.log('Validation completed successfully');
} catch (error) {
console.error('Error validating tickets:', error);
showError('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªØ°Ø§ÙƒØ±: ' + error.message);
}
}

// UI functions with better error handling
function displayResults(results) {
const container = document.getElementById('resultsContainer');
container.innerHTML = '';

if (results.length === 0) {
container.innerHTML = '<p style="text-align: center; color: #7f8c8d; padding: 2rem;">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ°Ø§ÙƒØ± ØªØ·Ø§Ø¨Ù‚ Ù…Ø¹Ø§ÙŠÙŠØ± Ø§Ù„ØªØµÙÙŠØ©</p>';
return;
}

results.forEach((result, index) => {
try {
const ticketCard = createTicketCard(result, index);
container.appendChild(ticketCard);
} catch (error) {
console.error('Error creating ticket card:', error);
}
});
}

function createTicketCard(result, index) {
const card = document.createElement('div');
const courtClass = `${result.courtType.toLowerCase()}-ticket`;
card.className = `ticket-card arabic-text ${courtClass}`;

const statusColor = result.isValid ? '#27ae60' : '#e74c3c';

card.innerHTML = `
<div class="ticket-header">
<div class="ticket-title">
<span class="service-badge">${result.ticket.affectedService || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</span>
${result.ticket.title || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¹Ù†ÙˆØ§Ù†'}
<div class="interaction-id">Ø±Ù‚Ù… Ø§Ù„ØªØ°ÙƒØ±Ø©: ${result.ticket.interactionId || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}</div>
</div>
<div class="validation-score" style="background: ${statusColor}">
${result.score}%
</div>
</div>

${result.isDuplicate ? `
<div class="duplicate-warning">
âš  ØªØ°ÙƒØ±Ø© Ù…Ø­ØªÙ…Ù„Ø© Ù…ÙƒØ±Ø±Ø©
</div>
` : ''}

${result.error ? `
<div class="error-message">
Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù‚Ù‚: ${result.error}
</div>
` : ''}

<div class="legal-highlight">
<strong>Ø§Ù„Ø®Ø¯Ù…Ø©:</strong> ${result.ticket.affectedService || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'} |
<strong>ÙƒÙˆØ¯ Ø§Ù„Ø¥ØºÙ„Ø§Ù‚:</strong> ${result.ticket.closureCode || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'} |
<strong>Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø­Ù„:</strong> ${result.ticket.resolutionMethod || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}
</div>

<div class="priority-indicators">
${!result.validations.description || !result.validations.description.isValid ? '<span style="background: #e74c3c; color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.8rem;">ÙˆØµÙ ØºÙŠØ± ÙƒØ§ÙÙŠ</span>' : ''}
${!result.validations.solution || !result.validations.solution.isValid ? '<span style="background: #e74c3c; color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.8rem;">Ø­Ù„ ØºÙŠØ± ÙØ¹Ø§Ù„</span>' : ''}
${result.validations.category && result.validations.category.hasWarning ? '<span style="background: #f39c12; color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.8rem;">ÙØ¦Ø© ØºÙŠØ± Ù…Ù†Ø§Ø³Ø¨Ø©</span>' : ''}
${result.validations.closureCode && result.validations.closureCode.hasWarning ? '<span style="background: #f39c12; color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.8rem;">ÙƒÙˆØ¯ Ø¥ØºÙ„Ø§Ù‚ ØºÙŠØ± Ù…Ù†Ø§Ø³Ø¨</span>' : ''}
</div>

${result.validations ? `
<div class="validation-details">
${Object.entries(result.validations).map(([field, validation]) => validation ? `
<div class="field-validation">
<div class="validation-icon ${validation.isValid ? (validation.hasWarning ? 'warning' : 'valid') : 'invalid'}">
${validation.isValid ? (validation.hasWarning ? 'âš ' : 'âœ“') : 'âœ—'}
</div>
<div class="field-info">
<div class="field-name">${getFieldNameArabic(field)}</div>
<div class="field-feedback">${validation.feedback.join(' â€¢ ')}</div>
</div>
</div>
` : '').join('')}
</div>
` : ''}

${result.hasWarnings || !result.isValid ? `
<div class="suggestions arabic-text">
<strong>Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª Ù„Ù„ØªØ­Ø³ÙŠÙ†:</strong>
<ul style="margin-top: 0.5rem; padding-right: 1.5rem;">
${!result.isValid ? '<li>Ø±Ø§Ø¬Ø¹ ÙˆØ£ØµÙ„Ø­ Ø§Ù„Ø­Ù‚ÙˆÙ„ ØºÙŠØ± Ø§Ù„ØµØ§Ù„Ø­Ø© ÙˆØ§Ù„Ù…Ø´Ø§Ø± Ø¥Ù„ÙŠÙ‡Ø§ Ø¨ âœ—</li>' : ''}
${result.hasWarnings ? '<li>Ø¹Ø§Ù„Ø¬ Ø§Ù„ØªØ­Ø°ÙŠØ±Ø§Øª Ø§Ù„Ù…Ø´Ø§Ø± Ø¥Ù„ÙŠÙ‡Ø§ Ø¨ âš  Ù„ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø¬ÙˆØ¯Ø©</li>' : ''}
${result.isDuplicate ? '<li>ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªÙƒØ±Ø§Ø± Ø§Ù„Ù…Ø­ØªÙ…Ù„ Ù…Ø¹ ØªØ°Ø§ÙƒØ± Ø£Ø®Ø±Ù‰</li>' : ''}
</ul>
</div>
` : ''}
`;

return card;
}

function getFieldNameArabic(field) {
const fieldNames = {
title: 'Ø§Ù„Ø¹Ù†ÙˆØ§Ù†',
description: 'Ø§Ù„ÙˆØµÙ',
solution: 'Ø§Ù„Ø­Ù„',
category: 'Ø§Ù„ÙØ¦Ø©',
subcategory: 'Ø§Ù„ÙØ¦Ø© Ø§Ù„ÙØ±Ø¹ÙŠØ©',
classification: 'Ø§Ù„ØªØµÙ†ÙŠÙ',
affectedService: 'Ø§Ù„Ø®Ø¯Ù…Ø© Ø§Ù„Ù…ØªØ£Ø«Ø±Ø©',
closureCode: 'ÙƒÙˆØ¯ Ø§Ù„Ø¥ØºÙ„Ø§Ù‚',
resolutionMethod: 'Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø­Ù„',
interactionId: 'Ø±Ù‚Ù… Ø§Ù„ØªØ°ÙƒØ±Ø©'
};
return fieldNames[field] || field;
}

function updateSummaryStats(results) {
const validCount = results.filter(r => r.isValid).length;
const warningCount = results.filter(r => r.hasWarnings).length;
const invalidCount = results.filter(r => !r.isValid).length;
const totalCount = results.length;

document.getElementById('validCount').textContent = validCount;
document.getElementById('warningCount').textContent = warningCount;
document.getElementById('invalidCount').textContent = invalidCount;
document.getElementById('totalCount').textContent = totalCount;
}

function filterTicketsByCourt(courtType) {
// Update active filter button
document.querySelectorAll('.court-filter-btn').forEach(btn => {
btn.classList.remove('active');
});
event.target.classList.add('active');

if (courtType === 'all') {
filteredResults = currentValidationResults;
} else {
filteredResults = currentValidationResults.filter(result => result.courtType === courtType);
}

displayResults(filteredResults);
updateSummaryStats(filteredResults);
}

function validateSampleData() {
const loadingIndicator = document.getElementById('loadingIndicator');
loadingIndicator.style.display = 'block';

// Updated sample data based on actual CSV
const sampleTickets = [
{
"Affected Service": "CMS - SJC",
"Description": "ÙŠØ±Ø¬Ù‰ Ù…Ù† Ø³Ø§Ø¯ØªÙƒÙ… Ø§Ù„ØªÙƒØ±Ù… Ø¨Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù†ÙŠØ§Ø¨Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø¯Ø¹ÙˆÙ‰ Ø±Ù‚Ù… (14166/2025/Ø¬Ù†Ø­Ø©/Ø§Ø³ØªØ¦Ù†Ø§Ù) Ø­Ø³Ø¨ Ø§Ø®ØªØµØ§Øµ Ø§Ù„Ø¯Ø§Ø¦Ø±Ø© Ù„Ø°Ù„Ùƒ Ù„Ø¥ÙƒÙ…Ø§Ù„ Ø§Ø¬Ø±Ø§Ø¡ Ø·Ù„Ø¨ Ø§Ù„Ø§Ø³ØªØ¦Ù†Ø§Ù",
"Closure Code": "Application",
"Title": "Ø·Ù„Ø¨ Ø§Ø¶Ø§ÙØ© Ø§Ù„Ù†ÙŠØ§Ø¨Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø¯Ø¹ÙˆÙ‰",
"Category": "CMS - Cases",
"Subcategory": "Case Details",
"Classification": "add case subject",
"Resolution Method": "Remote resolution",
"Solution": "ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù†ÙŠØ§Ø¨Ø© Ø§Ù„Ù…Ø®ØªØµØ©(Ù‚Ø¶Ø§ÙŠØ§ Ø§Ù„Ø´ÙŠÙƒØ§Øª) ÙˆØªÙ… Ø¥Ø¹Ø§Ø¯Ø© Ø¬Ø¯ÙˆÙ„Ø© Ø§Ù„Ø¯Ø¹ÙˆÙ‰ Ø±Ù‚Ù… 14166/2025/Ø¬Ù†Ø­Ø©/Ø§Ø³ØªØ¦Ù†Ø§Ù",
"Interaction ID": "SD1664592"
},
{
"Affected Service": "OSS - SJC",
"Description": "ÙŠÙØ±Ø¬ÙŠ Ø§Ù„Ø¹Ù„Ù… Ø¨Ø£Ù†Ù‡ ØªÙˆØ¬Ø¯ Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø¨Ù„Ø§ØºØ§Øª ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù… ( Ø§Ù…Ø± Ø¬Ù†Ø§Ø¦ÙŠ - Ø´Ø¤ÙˆÙ† Ø§Ù„Ø§Ù‚Ø§Ù…Ù‡ ) Ø­ÙŠØ« ØªØ¸Ù‡Ø± Ø±Ø³Ø§Ù„Ø© Ø¨Ø£Ù†Ù‡ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥ÙŠØ¬Ø§Ø¯ Ø§Ù„Ø¯Ø§Ø¦Ø±Ø© ÙˆØªØ§Ø±ÙŠØ® Ø§Ù„Ø¬Ù„Ø³Ø©",
"Closure Code": "Application",
"Title": "Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ù‚Ø¨ÙˆÙ„ Ø¨Ù„Ø§ØºØ§Øª Ø§Ù…Ø± Ø¬Ù†Ø§Ø¦ÙŠ Ø§Ù‚Ø§Ù…Ø©",
"Category": "CMS - Cases",
"Subcategory": "Case Related Case",
"Classification": "add related case",
"Resolution Method": "Remote resolution",
"Solution": "ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø¹Ù„Ù… Ø§Ù†Ù‡ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø´ÙƒÙ„Ø© Ø¨ØªØ³Ø¬ÙŠÙ„ ÙˆØ§Ù†Ù…Ø§ ØªÙ… Ø§ÙŠÙ‚Ø§Ù Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø³Ø§Ø¨Ù‚Ø§ Ø¨Ù‚Ø±Ø§Ø± Ù…Ù† Ø§Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø­ÙƒÙ…Ø©",
"Interaction ID": "SD1666246"
}
];

setTimeout(() => {
validateTickets(sampleTickets);
loadingIndicator.style.display = 'none';
}, 1000);
}

function exportResults() {
if (currentValidationResults.length === 0) {
alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù„ØªØµØ¯ÙŠØ±Ù‡Ø§');
return;
}

let csvContent = "Interaction ID,Title,Score,Status,Court Type,Affected Service,Closure Code,Category,Subcategory,Classification,Resolution Method\n";

currentValidationResults.forEach(result => {
const ticket = result.ticket;
const status = result.isValid ? "Valid" : "Invalid";
csvContent += `"${ticket.interactionId || ''}","${ticket.title || ''}",${result.score},${status},${result.courtType},"${ticket.affectedService || ''}","${ticket.closureCode || ''}","${ticket.category || ''}","${ticket.subcategory || ''}","${ticket.classification || ''}","${ticket.resolutionMethod || ''}"\n`;
});

const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
const link = document.createElement("a");
const url = URL.createObjectURL(blob);
link.setAttribute("href", url);
link.setAttribute("download", "ticket_validation_results.csv");
link.style.visibility = 'hidden';
document.body.appendChild(link);
link.click();
document.body.removeChild(link);
}

function clearResults() {
currentValidationResults = [];
filteredResults = [];
document.getElementById('resultsContainer').innerHTML = '<p style="text-align: center; color: #7f8c8d; padding: 2rem;">Ù‚Ù… Ø¨ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù Excel Ø£Ùˆ CSV Ù„Ø±Ø¤ÙŠØ© Ù†ØªØ§Ø¦Ø¬ Ø§Ù„ØªØ­Ù‚Ù‚</p>';
updateSummaryStats([]);
document.getElementById('exportBtn').style.display = 'none';
document.getElementById('clearBtn').style.display = 'none';
clearError();
hideFileInfo();
}

function showError(message) {
const errorDiv = document.getElementById('uploadError');
errorDiv.innerHTML = message;
errorDiv.style.display = 'block';
}

function clearError() {
const errorDiv = document.getElementById('uploadError');
errorDiv.style.display = 'none';
errorDiv.innerHTML = '';
}

function showFileInfo(file) {
const fileInfoDiv = document.getElementById('fileInfo');
const fileDetailsDiv = document.getElementById('fileDetails');

fileDetailsDiv.innerHTML = `
<div>Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù: ${file.name}</div>
<div>Ø­Ø¬Ù… Ø§Ù„Ù…Ù„Ù: ${(file.size / 1024).toFixed(2)} ÙƒÙŠÙ„ÙˆØ¨Ø§ÙŠØª</div>
<div>Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: ${file.type || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}</div>
`;

fileInfoDiv.style.display = 'block';
}

function hideFileInfo() {
document.getElementById('fileInfo').style.display = 'none';
}

function showDebugInfo(message) {
const fileDetailsDiv = document.getElementById('fileDetails');
const debugDiv = document.createElement('div');
debugDiv.className = 'debug-info';
debugDiv.textContent = message;
fileDetailsDiv.appendChild(debugDiv);
}

// Initialize the application with better event handling
document.addEventListener('DOMContentLoaded', function() {
const fileInput = document.getElementById('fileInput');
const uploadArea = document.getElementById('uploadArea');

fileInput.addEventListener('change', handleFileUpload);

uploadArea.addEventListener('click', () => {
fileInput.click();
});

// Drag and drop support
uploadArea.addEventListener('dragover', (e) => {
e.preventDefault();
uploadArea.classList.add('drag-over');
});

uploadArea.addEventListener('dragleave', () => {
uploadArea.classList.remove('drag-over');
});

uploadArea.addEventListener('drop', (e) => {
e.preventDefault();
uploadArea.classList.remove('drag-over');

if (e.dataTransfer.files.length) {
fileInput.files = e.dataTransfer.files;
handleFileUpload({ target: fileInput });
}
});

console.log('Application initialized successfully');
console.log('Validation rules:', validationRules);
});
</script>
</body>
</html>
