<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>نظام التحقق من التذاكر - متعدد المحاكم</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
* {
margin: 0;
padding: 0;
box-sizing: border-box;
font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

body {
background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
min-height: 100vh;
padding: 20px;
direction: rtl;
}

.container {
max-width: 1400px;
margin: 0 auto;
background: white;
border-radius: 15px;
box-shadow: 0 20px 40px rgba(0,0,0,0.1);
overflow: hidden;
}

header {
background: linear-gradient(135deg, #2c3e50, #3498db);
color: white;
padding: 2rem;
text-align: center;
}

h1 {
font-size: 2.5rem;
margin-bottom: 0.5rem;
}

.subtitle {
opacity: 0.9;
font-size: 1.1rem;
}

.main-content {
padding: 2rem;
display: grid;
grid-template-columns: 1fr 1fr;
gap: 2rem;
}

@media (max-width: 768px) {
.main-content {
grid-template-columns: 1fr;
}
}

.upload-section, .validation-section {
background: #f8f9fa;
padding: 2rem;
border-radius: 10px;
border: 2px dashed #dee2e6;
}

.upload-area {
border: 3px dashed #3498db;
border-radius: 10px;
padding: 3rem 2rem;
text-align: center;
background: #ecf0f1;
cursor: pointer;
transition: all 0.3s ease;
margin-bottom: 1.5rem;
}

.upload-area:hover {
background: #d6eaf8;
border-color: #2980b9;
}

.upload-area.drag-over {
background: #d6eaf8;
border-color: #2980b9;
}

.upload-icon {
font-size: 4rem;
color: #3498db;
margin-bottom: 1rem;
}

.file-input {
display: none;
}

.btn {
background: linear-gradient(135deg, #3498db, #2980b9);
color: white;
border: none;
padding: 12px 30px;
border-radius: 25px;
font-size: 1rem;
font-weight: 600;
cursor: pointer;
transition: all 0.3s ease;
margin: 5px;
}

.btn:hover {
transform: translateY(-2px);
box-shadow: 0 5px 15px rgba(0,0,0,0.2);
}

.btn-secondary {
background: linear-gradient(135deg, #95a5a6, #7f8c8d);
}

.btn-success {
background: linear-gradient(135deg, #27ae60, #2ecc71);
}

.btn-danger {
background: linear-gradient(135deg, #e74c3c, #c0392b);
}

.validation-results {
margin-top: 2rem;
max-height: 600px;
overflow-y: auto;
}

.ticket-card {
background: white;
border-radius: 10px;
padding: 1.5rem;
margin-bottom: 1rem;
box-shadow: 0 5px 15px rgba(0,0,0,0.1);
border-left: 5px solid #3498db;
}

.ticket-card.oss-ticket {
border-left-color: #e74c3c;
}

.ticket-card.jwb-ticket {
border-left-color: #f39c12;
}

.ticket-card.eservices-ticket {
border-left-color: #9b59b6;
}

.ticket-card.workplace-ticket {
border-left-color: #1abc9c;
}

.ticket-header {
display: flex;
justify-content: space-between;
align-items: center;
margin-bottom: 1rem;
}

.ticket-title {
font-size: 1.3rem;
font-weight: bold;
color: #2c3e50;
}

.interaction-id {
background: #e74c3c;
color: white;
padding: 6px 12px;
border-radius: 20px;
font-size: 0.9rem;
font-weight: bold;
margin-top: 8px;
display: inline-block;
}

.service-badge {
background: #3498db;
color: white;
padding: 4px 8px;
border-radius: 15px;
font-size: 0.8rem;
margin-right: 8px;
}

.validation-score {
background: #3498db;
color: white;
padding: 5px 15px;
border-radius: 20px;
font-weight: bold;
}

.validation-details {
margin-top: 1rem;
}

.field-validation {
display: flex;
align-items: center;
padding: 10px;
margin: 5px 0;
border-radius: 5px;
background: #f8f9fa;
}

.validation-icon {
width: 30px;
height: 30px;
border-radius: 50%;
display: flex;
align-items: center;
justify-content: center;
margin-left: 15px;
font-weight: bold;
}

.valid {
background: #27ae60;
color: white;
}

.invalid {
background: #e74c3c;
color: white;
}

.warning {
background: #f39c12;
color: white;
}

.field-info {
flex: 1;
}

.field-name {
font-weight: bold;
color: #2c3e50;
}

.field-feedback {
color: #7f8c8d;
font-size: 0.9rem;
margin-top: 2px;
}

.suggestions {
background: #e8f4fd;
border-right: 4px solid #3498db;
padding: 1rem;
margin-top: 1rem;
border-radius: 5px;
}

.summary-stats {
display: grid;
grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
gap: 1rem;
margin-bottom: 2rem;
}

.stat-card {
background: white;
padding: 1.5rem;
border-radius: 10px;
text-align: center;
box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}

.stat-number {
font-size: 2rem;
font-weight: bold;
display: block;
}

.stat-valid { color: #27ae60; }
.stat-invalid { color: #e74c3c; }
.stat-warning { color: #f39c12; }

.loading {
text-align: center;
padding: 2rem;
}

.spinner {
border: 4px solid #f3f3f3;
border-top: 4px solid #3498db;
border-radius: 50%;
width: 40px;
height: 40px;
animation: spin 1s linear infinite;
margin: 0 auto 1rem;
}

@keyframes spin {
0% { transform: rotate(0deg); }
100% { transform: rotate(360deg); }
}

.criteria-section {
background: #fff3cd;
border-right: 4px solid #ffc107;
padding: 1rem;
margin: 1rem 0;
border-radius: 5px;
}

.criteria-list {
list-style: none;
padding-right: 0;
}

.criteria-item {
padding: 0.5rem 0;
border-bottom: 1px solid #ffeaa7;
}

.criteria-item:last-child {
border-bottom: none;
}

/* Arabic text specific styles */
.arabic-text {
font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
line-height: 1.8;
}

.field-validation {
text-align: right;
}

.legal-highlight {
background: #fff3cd;
border-right: 4px solid #ffc107;
padding: 0.5rem;
margin: 0.5rem 0;
border-radius: 3px;
}

.court-filter {
display: flex;
gap: 10px;
margin-bottom: 1rem;
flex-wrap: wrap;
}

.court-filter-btn {
padding: 8px 16px;
border: 2px solid #3498db;
background: white;
border-radius: 20px;
cursor: pointer;
transition: all 0.3s;
}

.court-filter-btn.active {
background: #3498db;
color: white;
}

.court-filter-btn:hover {
background: #2980b9;
color: white;
}

.priority-indicators {
margin: 0.5rem 0;
display: flex;
gap: 10px;
flex-wrap: wrap;
}

.duplicate-warning {
background: #fff3cd;
border-right: 4px solid #ffc107;
padding: 0.75rem;
margin: 0.5rem 0;
border-radius: 5px;
font-weight: bold;
}

.reference-highlight {
background: #d4edda;
border-right: 4px solid #28a745;
padding: 0.5rem;
margin: 0.25rem 0;
border-radius: 3px;
font-family: monospace;
}

.error-message {
background: #f8d7da;
color: #721c24;
padding: 1rem;
border-radius: 5px;
margin: 1rem 0;
text-align: center;
border-right: 4px solid #dc3545;
}

.file-info {
background: #d1ecf1;
color: #0c5460;
padding: 1rem;
border-radius: 5px;
margin: 1rem 0;
border-right: 4px solid #17a2b8;
}

.debug-info {
background: #e2e3e5;
color: #383d41;
padding: 0.5rem;
border-radius: 3px;
margin: 0.25rem 0;
font-family: monospace;
font-size: 0.8rem;
}
</style>
</head>
<body>
<div class="container">
<header>
<h1>🎫 نظام التحقق من التذاكر - متعدد المحاكم</h1>
<p class="subtitle">نظام متكامل للتحقق الآلي من جودة تذاكر الدعم الفني لجميع المحاكم</p>
</header>

<!-- Main App Content -->
<div id="mainApp">
<div class="main-content">
<div class="upload-section">
<h2>📤 تحميل ملف Excel أو CSV</h2>
<p>قم بتحميل ملف Excel أو CSV الذي يحتوي على التذاكر بالأعمدة التالية:</p>
<ul style="margin: 1rem 0; padding-right: 2rem;">
<li><strong>Affected Service</strong> (CMS - SJC, OSS - SJC, E-Services - SJC, JWB - SJC, Workplace Services - SJC)</li>
<li><strong>Description</strong> (بالعربية - يجب أن تحتوي على رقم الدعوى/الطلب)</li>
<li><strong>Closure Code</strong> (Case Amended, Information Provided, Reports, Application, Duplicate Ticket, etc.)</li>
<li><strong>Title</strong> (بالعربية - 4-6 كلمات كحد أقصى)</li>
<li><strong>Category</strong> (بالإنجليزية)</li>
<li><strong>Subcategory</strong> (بالإنجليزية)</li>
<li><strong>Classification</strong> (بالإنجليزية)</li>
<li><strong>Resolution Method</strong> (بالإنجليزية)</li>
<li><strong>Solution</strong> (بالعربية - يجب أن تحتوي على إشارة للإنجاز)</li>
<li><strong>Interaction ID</strong> (رقم التذكرة - مثل SD1664592)</li>
</ul>

<div class="upload-area" id="uploadArea">
<div class="upload-icon">📊</div>
<h3>اسحب ملف Excel أو CSV هنا</h3>
<p>أو انقر للتصفح (يدعم Excel و CSV)</p>
<input type="file" id="fileInput" class="file-input" accept=".xlsx, .xls, .csv, .txt">
</div>

<div id="fileInfo" class="file-info" style="display: none;">
<strong>معلومات الملف:</strong>
<div id="fileDetails"></div>
</div>

<div id="uploadError" class="error-message" style="display: none;">
<!-- Error messages will appear here -->
</div>

<div class="criteria-section">
<h4>🔍 معايير التحقق المحسنة</h4>
<ul class="criteria-list">
<li class="criteria-item"><strong>الوصف:</strong> يجب أن يحتوي على رقم الدعوى/الطلب (مثال: 14166/2025/جنحة/استئناف)</li>
<li class="criteria-item"><strong>الحل:</strong> يجب أن يوضح الإجراء الملموس وليس مجرد توجيه</li>
<li class="criteria-item"><strong>الفئة والتصنيف:</strong> يجب أن تتطابق مع نوع الخدمة المتأثرة</li>
<li class="criteria-item"><strong>كود الإغلاق:</strong> يجب أن يكون مناسباً لنوع الخدمة</li>
<li class="criteria-item"><strong>التكرار:</strong> الكشف عن التذاكر المكررة</li>
<li class="criteria-item"><strong>المراجع:</strong> التأكد من وجود أرقام الدعاوى والطلبات</li>
</ul>
</div>

<button class="btn" onclick="document.getElementById('fileInput').click()">
اختر ملف
</button>
<button class="btn btn-secondary" onclick="validateSampleData()">
تجربة بيانات نموذجية
</button>
<button class="btn btn-success" onclick="exportResults()" id="exportBtn" style="display: none;">
تصدير النتائج
</button>
<button class="btn btn-danger" onclick="clearResults()" id="clearBtn" style="display: none;">
مسح النتائج
</button>
</div>

<div class="validation-section">
<h2>📋 نتائج التحقق</h2>

<div class="court-filter" id="courtFilter">
<button class="court-filter-btn active" onclick="filterTicketsByCourt('all')">جميع المحاكم</button>
<button class="court-filter-btn" onclick="filterTicketsByCourt('CMS')">محاكم الأسرة (CMS)</button>
<button class="court-filter-btn" onclick="filterTicketsByCourt('OSS')">الخدمة الموحدة (OSS)</button>
<button class="court-filter-btn" onclick="filterTicketsByCourt('JWB')">منصة القضاة (JWB)</button>
<button class="court-filter-btn" onclick="filterTicketsByCourt('E-Services')">الخدمات الإلكترونية</button>
<button class="court-filter-btn" onclick="filterTicketsByCourt('Workplace')">خدمات مكان العمل</button>
</div>

<div id="summaryStats" class="summary-stats">
<div class="stat-card">
<span class="stat-number stat-valid" id="validCount">0</span>
<span>تذاكر صالحة</span>
</div>
<div class="stat-card">
<span class="stat-number stat-warning" id="warningCount">0</span>
<span>تحذيرات</span>
</div>
<div class="stat-card">
<span class="stat-number stat-invalid" id="invalidCount">0</span>
<span>تذاكر غير صالحة</span>
</div>
<div class="stat-card">
<span class="stat-number" id="totalCount" style="color: #3498db;">0</span>
<span>إجمالي التذاكر</span>
</div>
</div>

<div id="validationResults" class="validation-results">
<div class="loading" id="loadingIndicator" style="display: none;">
<div class="spinner"></div>
<p>جاري تحليل التذاكر...</p>
</div>
<div id="resultsContainer">
<p style="text-align: center; color: #7f8c8d; padding: 2rem;">
قم بتحميل ملف Excel أو CSV لرؤية نتائج التحقق
</p>
</div>
</div>
</div>
</div>
</div>
</div>

<script>
// Enhanced validation rules for multiple courts based on actual CSV analysis
let validationRules = {
title: {
maxWords: 6,
minLength: 5,
maxLength: 80,
shouldNotContain: ['اختبار', 'مؤقت', 'مسودة', 'يرجى', 'التكرم'],
requiredKeywords: ['طلب', 'مشكلة', 'إضافة', 'تعديل', 'إغلاق', 'صلاحية', 'تحقق', 'تدقيق', 'بلاغ', 'دعوى']
},
description: {
minLength: 15,
requiredElements: ['رقم', 'دعوى', 'طلب', 'بلاغ'],
mustContainReference: true,
referencePatterns: [
/\d+\/\d+\/\w+\/\w+/, // Pattern for case numbers: 14166/2025/جنحة/استئناف
/SD\d+/, // Interaction ID pattern
/رقم\s+(الدعوى|الطلب|البلاغ)\s*[\d\/\w]+/,
/\d{4}\/\d+\/\w+\/\w+/ // Another case number pattern
]
},
solution: {
minLength: 20,
requiredElements: ['تم', 'إضافة', 'تعديل', 'إغلاق', 'تحقق', 'تحديث'],
actionWords: ['تم', 'تمت', 'انتهى', 'أكمل', 'أنهى', 'نفذ', 'أنجز', 'تم التحقق', 'تم التحديث', 'تم الإصلاح', 'تم الحل'],
mustShowAction: true,
forbiddenPhrases: ['تم التوجيه فقط', 'يجب التواصل مع', 'حسب المطلوب', 'يجب ارسال ايميل']
},

// Enhanced service-specific rules based on actual data
affectedService: {
validServices: ['CMS - SJC', 'OSS - SJC', 'E-Services - SJC', 'JWB - SJC', 'Workplace Services - SJC'],
courtMapping: {
'CMS - SJC': 'CMS',
'OSS - SJC': 'OSS',
'E-Services - SJC': 'E-Services',
'JWB - SJC': 'JWB',
'Workplace Services - SJC': 'Workplace'
},
serviceExpectations: {
'CMS - SJC': {
commonCategories: ['CMS - Cases', 'CMS - Requests', 'CMS - Access', 'CMS - Court Rooms', 'CMS - Case Management'],
commonClosures: ['Application', 'Case Amended', 'Reports', 'Duplicate Ticket']
},
'OSS - SJC': {
commonCategories: ['CMS - Requests', 'Functional Support', 'CMS - Cases'],
commonClosures: ['Information Provided', 'Application', 'Duplicate Ticket']
},
'JWB - SJC': {
commonCategories: ['JWB - SJC', 'Functional Support'],
commonClosures: ['Information Provided', 'Application']
},
'E-Services - SJC': {
commonCategories: ['E-Services - SJC', 'Functional Support'],
commonClosures: ['Information Provided', 'Application']
},
'Workplace Services - SJC': {
commonCategories: ['Functional Support', 'CMS - Cases'],
commonClosures: ['Application', 'Information Provided']
}
}
},

// Enhanced closure code validation
closureCode: {
validCodes: [
'Case Amended', 'Information Provided', 'Reports', 'Application',
'Duplicate Ticket', 'Functional Low', 'Functional High', 'No action taken/required',
'Decision Amended', 'User Training', 'Request Amended'
],
// More specific service-closure mapping
serviceSpecific: {
'CMS - SJC': ['Case Amended', 'Application', 'Reports', 'Duplicate Ticket'],
'OSS - SJC': ['Information Provided', 'Application', 'Duplicate Ticket'],
'E-Services - SJC': ['Information Provided', 'Application'],
'JWB - SJC': ['Information Provided', 'Application', 'Decision Amended'],
'Workplace Services - SJC': ['Application', 'Information Provided']
}
},

// Enhanced category validation based on actual data analysis
categories: {
main: [
'CMS - Cases', 'CMS - Requests', 'CMS - Access', 'CMS - Court Rooms',
'Functional Support', 'CMS - Case Management', 'Data Cleansing',
'OSS - SJC', 'JWB - SJC', 'E-Services - SJC'
],
serviceMapping: {
'CMS - SJC': ['CMS - Cases', 'CMS - Requests', 'CMS - Access', 'CMS - Court Rooms', 'CMS - Case Management', 'Data Cleansing'],
'OSS - SJC': ['Functional Support', 'CMS - Requests', 'CMS - Cases'],
'JWB - SJC': ['JWB - SJC', 'Functional Support'],
'E-Services - SJC': ['E-Services - SJC', 'Functional Support'],
'Workplace Services - SJC': ['Functional Support', 'CMS - Cases']
},
// Updated subcategories based on actual CSV data
subcategories: {
'CMS - Cases': ['Case Status', 'Panel Details', 'Case Details', 'Hearings', 'Attachments', 'Case Related Case', 'technical issue'],
'CMS - Requests': ['Request Status', 'Attachments', 'Payments Details'],
'CMS - Access': ['User Access', 'Grant/Revoke Access'],
'CMS - Court Rooms': ['Panel Team', 'Panel Details'],
'Functional Support': ['CMS Application', 'Request for Information'],
'CMS - Case Management': ['FS Team Tasks', 'Summary Report', 'Investigation', 'Parties'],
'Data Cleansing': ['CMS', 'Edit Request'],
'OSS - SJC': ['Request Status', 'technical issue'],
'JWB - SJC': ['Request Status', 'Judge Workbench'],
'E-Services - SJC': ['Request Status', 'Portal Issues']
}
},

// Updated classifications based on actual data
classifications: [
'add case subject', 'change case status', 'add related case', 'Change Panel',
'amend request status', 'Grant/Revoke Access', 'Request for Information',
'error message', 'unable to add related case', 'Change Attachment type',
'Help user', 'Edit Request', 'amend hearing session type', 'RFI',
'Investigation', 'add panel member', 'delete panel member', 'amend hearing session status',
'Hearing session not created', 'Summary Report', 'FS Team Tasks'
]
};

// Global variables
let currentValidationResults = [];
let filteredResults = [];

// Enhanced validation functions for multiple courts
function validateSingleTicket(ticket) {
try {
const validations = {
title: validateTitle(ticket.Title || ticket.title || ''),
description: validateDescription(ticket.Description || ticket.description || ''),
solution: validateSolution(ticket.Solution || ticket.solution || ''),
category: validateCategory(ticket.Category || ticket.category || '', ticket['Affected Service'] || ticket.affectedService || ''),
subcategory: validateSubcategory(ticket.Category || ticket.category || '', ticket.Subcategory || ticket.subcategory || ''),
classification: validateClassification(ticket.Classification || ticket.classification || ''),
affectedService: validateAffectedService(ticket['Affected Service'] || ticket.affectedService || ''),
closureCode: validateClosureCode(ticket['Closure Code'] || ticket.closureCode || '', ticket['Affected Service'] || ticket.affectedService || ''),
resolutionMethod: validateResolutionMethod(ticket['Resolution Method'] || ticket.resolutionMethod || ''),
interactionId: validateInteractionId(ticket['Interaction ID'] || ticket['Interaction_ID'] || ticket.interactionId || '')
};

const totalFields = Object.keys(validations).length;
const validFields = Object.values(validations).filter(v => v.isValid).length;
const warningFields = Object.values(validations).filter(v => v.hasWarning).length;

const score = Math.round((validFields / totalFields) * 100);

// Determine court type for filtering
const courtType = validationRules.affectedService.courtMapping[ticket['Affected Service'] || ticket.affectedService || ''] || 'Other';

return {
ticket,
validations,
score,
courtType: courtType,
isValid: score >= 70,
hasWarnings: warningFields > 0
};
} catch (error) {
console.error('Error validating ticket:', ticket, error);
return {
ticket,
validations: {},
score: 0,
courtType: 'Error',
isValid: false,
hasWarnings: false,
error: error.message
};
}
}

function validateAffectedService(service) {
const result = { isValid: true, hasWarning: false, feedback: [] };

if (!service) {
result.isValid = false;
result.feedback.push('الخدمة المتأثرة مطلوبة');
return result;
}

if (!validationRules.affectedService.validServices.includes(service)) {
result.isValid = false;
result.feedback.push(`خدمة غير صالحة. الخيارات: ${validationRules.affectedService.validServices.join(', ')}`);
} else {
result.feedback.push(`الخدمة المتأثرة صحيحة (${service})`);
}

return result;
}

function validateClosureCode(closureCode, affectedService) {
const result = { isValid: true, hasWarning: false, feedback: [] };

if (!closureCode) {
result.isValid = false;
result.feedback.push('كود الإغلاق مطلوب');
return result;
}

if (!validationRules.closureCode.validCodes.includes(closureCode)) {
result.isValid = false;
result.feedback.push(`كود إغلاق غير صالح. الخيارات: ${validationRules.closureCode.validCodes.join(', ')}`);
return result;
}

// Check if closure code is appropriate for the service
const serviceCodes = validationRules.closureCode.serviceSpecific[affectedService];
if (serviceCodes && !serviceCodes.includes(closureCode)) {
result.hasWarning = true;
result.feedback.push(`كود الإغلاق "${closureCode}" غير معتاد للخدمة "${affectedService}"`);
} else {
result.feedback.push('كود الإغلاق مناسب للخدمة');
}

return result;
}

function validateCategory(category, affectedService) {
const result = { isValid: true, hasWarning: false, feedback: [] };

if (!category) {
result.isValid = false;
result.feedback.push('الفئة مطلوبة');
return result;
}

if (!validationRules.categories.main.includes(category)) {
result.isValid = false;
result.feedback.push(`فئة غير صالحة: "${category}"`);
return result;
}

// Check if category matches the affected service
const serviceCategories = validationRules.categories.serviceMapping[affectedService];
if (serviceCategories && !serviceCategories.includes(category)) {
result.hasWarning = true;
result.feedback.push(`الفئة "${category}" غير معتادة للخدمة "${affectedService}"`);
} else {
result.feedback.push(`الفئة مناسبة للخدمة`);
}

return result;
}

function validateSubcategory(category, subcategory) {
const result = { isValid: true, hasWarning: false, feedback: [] };

if (!subcategory) {
result.isValid = false;
result.feedback.push('الفئة الفرعية مطلوبة');
return result;
}

const validSubcategories = validationRules.categories.subcategories[category];
if (!validSubcategories || !validSubcategories.includes(subcategory)) {
result.isValid = false;
result.feedback.push(`فئة فرعية غير صالحة لـ "${category}"`);
} else {
result.feedback.push('الفئة الفرعية تطابق الفئة الرئيسية');
}

return result;
}

function validateResolutionMethod(method) {
const result = { isValid: true, hasWarning: false, feedback: [] };

if (!method) {
result.isValid = false;
result.feedback.push('طريقة الحل مطلوبة');
return result;
}

if (!validationRules.resolutionMethod.validMethods.includes(method)) {
result.hasWarning = true;
result.feedback.push(`طريقة حل غير معتمدة. الخيارات الموصى بها: ${validationRules.resolutionMethod.validMethods.join(', ')}`);
} else {
result.feedback.push('طريقة الحل مناسبة');
}

return result;
}

function validateInteractionId(interactionId) {
const result = { isValid: true, hasWarning: false, feedback: [] };

if (!interactionId) {
result.isValid = false;
result.feedback.push('رقم التذكرة (Interaction ID) مطلوب');
return result;
}

const interactionIdPattern = /^SD\d+$/;
if (!interactionIdPattern.test(interactionId)) {
result.hasWarning = true;
result.feedback.push('رقم التذكرة يجب أن يتبع التنسيق SD متبوعاً بأرقام');
} else {
result.feedback.push('رقم التذكرة صحيح');
}

return result;
}

// Enhanced validation functions
function countWords(text) {
if (!text) return 0;
return text.trim().split(/[\s\u0600-\u06FF,.;:!?]+/).filter(word => word.length > 0).length;
}

function validateTitle(title) {
const result = { isValid: true, hasWarning: false, feedback: [] };

if (!title) {
result.isValid = false;
result.feedback.push('العنوان مطلوب');
return result;
}

const wordCount = countWords(title);

if (wordCount > validationRules.title.maxWords) {
result.isValid = false;
result.feedback.push(`العنوان طويل جداً (الحد الأقصى ${validationRules.title.maxWords} كلمات)`);
}

if (title.length < validationRules.title.minLength) {
result.isValid = false;
result.feedback.push(`العنوان قصير جداً (الحد الأدنى ${validationRules.title.minLength} حرف)`);
}

const hasKeyword = validationRules.title.requiredKeywords.some(keyword =>
title.includes(keyword)
);

if (!hasKeyword) {
result.hasWarning = true;
result.feedback.push(`يفضل إضافة كلمات مفتاحية مناسبة`);
}

if (result.feedback.length === 0) {
result.feedback.push('العنوان يلبي المتطلبات');
}

return result;
}

function validateDescription(description) {
const result = { isValid: true, hasWarning: false, feedback: [] };

if (!description || description.length < validationRules.description.minLength) {
result.isValid = false;
result.feedback.push(`الوصف قصير جداً (الحد الأدنى ${validationRules.description.minLength} حرف)`);
return result;
}

// Check for case/request numbers using patterns
const hasReference = validationRules.description.referencePatterns.some(pattern =>
pattern.test(description)
);

if (!hasReference) {
result.isValid = false;
result.feedback.push('يجب ذكر رقم الدعوى أو الطلب أو البلاغ في الوصف (مثال: 14166/2025/جنحة/استئناف)');
}

// Check if description is just copied email (contains greetings)
const isEmailCopy = description.includes('التحية والتقدير') ||
description.includes('يرجى التكرم') ||
description.includes('مع خالص الشكر');

if (isEmailCopy) {
result.hasWarning = true;
result.feedback.push('الوصف يحتوي على صيغ خطابية - يفضل صياغة الوصف بشكل تقني مباشر');
}

if (result.feedback.length === 0) {
result.feedback.push('الوصف شامل ويحتوي على المراجع المطلوبة');
}

return result;
}

function validateSolution(solution) {
const result = { isValid: true, hasWarning: false, feedback: [] };

if (!solution || solution.length < validationRules.solution.minLength) {
result.isValid = false;
result.feedback.push(`الحل مختصر جداً (الحد الأدنى ${validationRules.solution.minLength} حرف)`);
return result;
}

// Check for action words
const hasActionWord = validationRules.solution.actionWords.some(word =>
solution.includes(word)
);

if (!hasActionWord) {
result.isValid = false;
result.feedback.push('الحل يجب أن يحتوي على إشارة للإنجاز (تم، تمت، إلخ)');
}

// Check for weak solutions
const hasForbiddenPhrase = validationRules.solution.forbiddenPhrases.some(phrase =>
solution.includes(phrase)
);

if (hasForbiddenPhrase) {
result.hasWarning = true;
result.feedback.push('الحل يحتوي على عبارات غير فعالة (يجب توضيح الإجراء الملموس)');
}

// Check if solution shows what was actually done
const hasSpecificAction = solution.includes('تم إضافة') ||
solution.includes('تم تعديل') ||
solution.includes('تم إغلاق') ||
solution.includes('تم التحقق');

if (!hasSpecificAction) {
result.hasWarning = true;
result.feedback.push('يفضل توضيح الإجراء المحدد الذي تم تنفيذه');
}

if (result.feedback.length === 0) {
result.feedback.push('الحل واضح ويوضح الإجراء والنتيجة');
}

return result;
}

function validateClassification(classification) {
const result = { isValid: true, hasWarning: false, feedback: [] };

if (!classification) {
result.isValid = false;
result.feedback.push('التصنيف مطلوب');
return result;
}

if (!validationRules.classifications.includes(classification)) {
result.isValid = false;
result.feedback.push(`تصنيف غير صالح`);
} else {
result.feedback.push('التصنيف مناسب');
}

return result;
}

// Duplicate detection function
function detectPotentialDuplicates(tickets) {
const duplicates = [];
const titleMap = new Map();

tickets.forEach((ticket, index) => {
const simpleTitle = ticket.Title?.replace(/[^أ-يa-z0-9]/gi, '').toLowerCase();
if (titleMap.has(simpleTitle)) {
duplicates.push({
ticket1: titleMap.get(simpleTitle),
ticket2: index,
title: ticket.Title
});
} else {
titleMap.set(simpleTitle, index);
}
});

return duplicates;
}

// File processing functions with better error handling
function handleFileUpload(event) {
const file = event.target.files[0];
if (!file) return;

// Reset previous results
clearError();
hideFileInfo();

const loadingIndicator = document.getElementById('loadingIndicator');
loadingIndicator.style.display = 'block';

// Show file info
showFileInfo(file);

setTimeout(() => {
processExcelFile(file);
loadingIndicator.style.display = 'none';
}, 500);
}

function processExcelFile(file) {
const reader = new FileReader();

reader.onload = function(e) {
try {
const data = new Uint8Array(e.target.result);
let workbook;

if (file.name.endsWith('.csv')) {
const csvData = new TextDecoder().decode(data);
workbook = XLSX.read(csvData, { type: 'string', raw: true });
} else {
workbook = XLSX.read(data, { type: 'array' });
}

console.log('Workbook sheets:', workbook.SheetNames);

const worksheet = workbook.Sheets[workbook.SheetNames[0]];
const jsonData = XLSX.utils.sheet_to_json(worksheet);

console.log('Parsed data:', jsonData);

if (jsonData.length === 0) {
showError('الملف لا يحتوي على بيانات أو تنسيق الملف غير صحيح');
return;
}

// Show column names for debugging
const firstRow = jsonData[0];
console.log('Column names:', Object.keys(firstRow));
showDebugInfo('أسماء الأعمدة المكتشفة: ' + Object.keys(firstRow).join(', '));

validateTickets(jsonData);
} catch (error) {
console.error('Error processing file:', error);
showError('خطأ في معالجة الملف: ' + error.message);
}
};

reader.onerror = function() {
showError('خطأ في قراءة الملف');
};

if (file.name.endsWith('.csv')) {
reader.readAsArrayBuffer(file);
} else {
reader.readAsArrayBuffer(file);
}
}

function validateTickets(tickets) {
try {
console.log('Starting validation of', tickets.length, 'tickets');

const validationResults = tickets.map(ticket => validateSingleTicket(ticket));

// Detect duplicates
const duplicates = detectPotentialDuplicates(tickets);
if (duplicates.length > 0) {
console.log('Potential duplicates found:', duplicates);
// Mark duplicates in results
duplicates.forEach(dup => {
if (validationResults[dup.ticket1]) validationResults[dup.ticket1].isDuplicate = true;
if (validationResults[dup.ticket2]) validationResults[dup.ticket2].isDuplicate = true;
});
}

currentValidationResults = validationResults;
filteredResults = validationResults;
displayResults(validationResults);
updateSummaryStats(validationResults);

document.getElementById('exportBtn').style.display = 'inline-block';
document.getElementById('clearBtn').style.display = 'inline-block';

console.log('Validation completed successfully');
} catch (error) {
console.error('Error validating tickets:', error);
showError('خطأ في التحقق من التذاكر: ' + error.message);
}
}

// UI functions with better error handling
function displayResults(results) {
const container = document.getElementById('resultsContainer');
container.innerHTML = '';

if (results.length === 0) {
container.innerHTML = '<p style="text-align: center; color: #7f8c8d; padding: 2rem;">لا توجد تذاكر تطابق معايير التصفية</p>';
return;
}

results.forEach((result, index) => {
const ticketCard = createTicketCard(result, index);
container.appendChild(ticketCard);
});
}

function createTicketCard(result, index) {
const card = document.createElement('div');
const courtClass = `${result.courtType.toLowerCase()}-ticket`;
card.className = `ticket-card arabic-text ${courtClass}`;

const statusColor = result.isValid ? '#27ae60' : '#e74c3c';

// Extract Interaction ID from the ticket data
const interactionId = result.ticket['Interaction ID'] || result.ticket['Interaction_ID'] || result.ticket.interactionId || 'غير معروف';

card.innerHTML = `
<div class="ticket-header">
<div class="ticket-title">
<span class="service-badge">${result.ticket['Affected Service'] || result.ticket.affectedService || 'غير محدد'}</span>
${result.ticket.Title || result.ticket.title || 'لا يوجد عنوان'}
<div class="interaction-id">رقم التذكرة: ${interactionId}</div>
</div>
<div class="validation-score" style="background: ${statusColor}">
${result.score}%
</div>
</div>

${result.isDuplicate ? `
<div class="duplicate-warning">
⚠ تذكرة محتملة مكررة
</div>
` : ''}

${result.error ? `
<div class="error-message">
خطأ في التحقق: ${result.error}
</div>
` : ''}

<div class="legal-highlight">
<strong>الخدمة:</strong> ${result.ticket['Affected Service'] || result.ticket.affectedService || 'غير محدد'} |
<strong>كود الإغلاق:</strong> ${result.ticket['Closure Code'] || result.ticket.closureCode || 'غير محدد'} |
<strong>طريقة الحل:</strong> ${result.ticket['Resolution Method'] || result.ticket.resolutionMethod || 'غير محدد'}
</div>

<div class="priority-indicators">
${!result.validations.description || !result.validations.description.isValid ? '<span style="background: #e74c3c; color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.8rem;">وصف غير كافي</span>' : ''}
${!result.validations.solution || !result.validations.solution.isValid ? '<span style="background: #e74c3c; color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.8rem;">حل غير فعال</span>' : ''}
${result.validations.category && result.validations.category.hasWarning ? '<span style="background: #f39c12; color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.8rem;">فئة غير مناسبة</span>' : ''}
${result.validations.closureCode && result.validations.closureCode.hasWarning ? '<span style="background: #f39c12; color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.8rem;">كود إغلاق غير مناسب</span>' : ''}
</div>

${result.validations ? `
<div class="validation-details">
${Object.entries(result.validations).map(([field, validation]) => `
<div class="field-validation">
<div class="validation-icon ${validation.isValid ? (validation.hasWarning ? 'warning' : 'valid') : 'invalid'}">
${validation.isValid ? (validation.hasWarning ? '⚠' : '✓') : '✗'}
</div>
<div class="field-info">
<div class="field-name">${getFieldNameArabic(field)}</div>
<div class="field-feedback">${validation.feedback.join(' • ')}</div>
</div>
</div>
`).join('')}
</div>
` : ''}

${result.hasWarnings || !result.isValid ? `
<div class="suggestions arabic-text">
<strong>اقتراحات للتحسين:</strong>
<ul style="margin-top: 0.5rem; padding-right: 1.5rem;">
${!result.isValid ? '<li>راجع وأصلح الحقول غير الصالحة والمشار إليها ب ✗</li>' : ''}
${result.hasWarnings ? '<li>عالج التحذيرات المشار إليها ب ⚠ لتحسين الجودة</li>' : ''}
${result.isDuplicate ? '<li>تحقق من التكرار المحتمل مع تذاكر أخرى</li>' : ''}
</ul>
</div>
` : ''}
`;

return card;
}

function getFieldNameArabic(field) {
const fieldNames = {
title: 'العنوان',
description: 'الوصف',
solution: 'الحل',
category: 'الفئة',
subcategory: 'الفئة الفرعية',
classification: 'التصنيف',
affectedService: 'الخدمة المتأثرة',
closureCode: 'كود الإغلاق',
resolutionMethod: 'طريقة الحل',
interactionId: 'رقم التذكرة'
};
return fieldNames[field] || field;
}

function updateSummaryStats(results) {
const validCount = results.filter(r => r.isValid).length;
const warningCount = results.filter(r => r.hasWarnings).length;
const invalidCount = results.filter(r => !r.isValid).length;
const totalCount = results.length;

document.getElementById('validCount').textContent = validCount;
document.getElementById('warningCount').textContent = warningCount;
document.getElementById('invalidCount').textContent = invalidCount;
document.getElementById('totalCount').textContent = totalCount;
}

function filterTicketsByCourt(courtType) {
// Update active filter button
document.querySelectorAll('.court-filter-btn').forEach(btn => {
btn.classList.remove('active');
});
event.target.classList.add('active');

if (courtType === 'all') {
filteredResults = currentValidationResults;
} else {
filteredResults = currentValidationResults.filter(result => result.courtType === courtType);
}

displayResults(filteredResults);
updateSummaryStats(filteredResults);
}

function validateSampleData() {
const loadingIndicator = document.getElementById('loadingIndicator');
loadingIndicator.style.display = 'block';

// Updated sample data based on actual CSV
const sampleTickets = [
{
"Affected Service": "CMS - SJC",
"Description": "يرجى من سادتكم التكرم بإضافة النيابة على الدعوى رقم (14166/2025/جنحة/استئناف) حسب اختصاص الدائرة لذلك لإكمال اجراء طلب الاستئناف",
"Closure Code": "Application",
"Title": "طلب اضافة النيابة على الدعوى",
"Category": "CMS - Cases",
"Subcategory": "Case Details",
"Classification": "add case subject",
"Resolution Method": "Remote resolution",
"Solution": "تم إضافة النيابة المختصة(قضايا الشيكات) وتم إعادة جدولة الدعوى رقم 14166/2025/جنحة/استئناف",
"Interaction ID": "SD1664592"
},
{
"Affected Service": "OSS - SJC",
"Description": "يُرجي العلم بأنه توجد مشكلة في قبول البلاغات في النظام ( امر جنائي - شؤون الاقامه ) حيث تظهر رسالة بأنه لا يمكن إيجاد الدائرة وتاريخ الجلسة",
"Closure Code": "Application",
"Title": "مشكلة في قبول بلاغات امر جنائي اقامة",
"Category": "CMS - Cases",
"Subcategory": "Case Related Case",
"Classification": "add related case",
"Resolution Method": "Remote resolution",
"Solution": "يرجى العلم انه لا يوجد مشكلة بتسجيل وانما تم ايقاف التسجيل سابقا بقرار من ادارة المحكمة",
"Interaction ID": "SD1666246"
},
{
"Affected Service": "Workplace Services - SJC",
"Description": "يُرجي العلم بأنه توجد مشكلة في قبول البلاغات في النظام ( امر جنائي – مرور /ق ) حيث تظهر رسالة بأنه لا يمكن إيجاد الدائرة وتاريخ الجلسة",
"Closure Code": "Application",
"Title": "مشكله في قبول بعض البلاغات",
"Category": "CMS - Cases",
"Subcategory": "technical issue",
"Classification": "error message",
"Resolution Method": "Remote resolution",
"Solution": "يرجى العلم وبناء على إفادة القسم التقني بعدم وجود اشكالية بنظام",
"Interaction ID": "SD1670691"
}
];

setTimeout(() => {
validateTickets(sampleTickets);
loadingIndicator.style.display = 'none';
}, 1000);
}

function exportResults() {
if (currentValidationResults.length === 0) {
alert('لا توجد نتائج لتصديرها');
return;
}

let csvContent = "Interaction ID,Title,Score,Status,Court Type,Affected Service,Closure Code,Category,Subcategory,Classification,Resolution Method\n";

currentValidationResults.forEach(result => {
const ticket = result.ticket;
const interactionId = ticket['Interaction ID'] || ticket['Interaction_ID'] || ticket.interactionId || 'N/A';
const status = result.isValid ? "Valid" : "Invalid";
csvContent += `"${interactionId}","${ticket.Title || ticket.title || ''}",${result.score},${status},${result.courtType},${ticket['Affected Service'] || ticket.affectedService || ''},${ticket['Closure Code'] || ticket.closureCode || ''},${ticket.Category || ticket.category || ''},${ticket.Subcategory || ticket.subcategory || ''},${ticket.Classification || ticket.classification || ''},${ticket['Resolution Method'] || ticket.resolutionMethod || ''}\n`;
});

const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
const link = document.createElement("a");
const url = URL.createObjectURL(blob);
link.setAttribute("href", url);
link.setAttribute("download", "ticket_validation_results.csv");
link.style.visibility = 'hidden';
document.body.appendChild(link);
link.click();
document.body.removeChild(link);
}

function clearResults() {
currentValidationResults = [];
filteredResults = [];
document.getElementById('resultsContainer').innerHTML = '<p style="text-align: center; color: #7f8c8d; padding: 2rem;">قم بتحميل ملف Excel أو CSV لرؤية نتائج التحقق</p>';
updateSummaryStats([]);
document.getElementById('exportBtn').style.display = 'none';
document.getElementById('clearBtn').style.display = 'none';
clearError();
hideFileInfo();
}

function showError(message) {
const errorDiv = document.getElementById('uploadError');
errorDiv.innerHTML = message;
errorDiv.style.display = 'block';
}

function clearError() {
const errorDiv = document.getElementById('uploadError');
errorDiv.style.display = 'none';
errorDiv.innerHTML = '';
}

function showFileInfo(file) {
const fileInfoDiv = document.getElementById('fileInfo');
const fileDetailsDiv = document.getElementById('fileDetails');

fileDetailsDiv.innerHTML = `
<div>اسم الملف: ${file.name}</div>
<div>حجم الملف: ${(file.size / 1024).toFixed(2)} كيلوبايت</div>
<div>نوع الملف: ${file.type || 'غير معروف'}</div>
`;

fileInfoDiv.style.display = 'block';
}

function hideFileInfo() {
document.getElementById('fileInfo').style.display = 'none';
}

function showDebugInfo(message) {
const fileDetailsDiv = document.getElementById('fileDetails');
const debugDiv = document.createElement('div');
debugDiv.className = 'debug-info';
debugDiv.textContent = message;
fileDetailsDiv.appendChild(debugDiv);
}

// Initialize the application with better event handling
document.addEventListener('DOMContentLoaded', function() {
const fileInput = document.getElementById('fileInput');
const uploadArea = document.getElementById('uploadArea');

fileInput.addEventListener('change', handleFileUpload);

uploadArea.addEventListener('click', () => {
fileInput.click();
});

// Drag and drop support
uploadArea.addEventListener('dragover', (e) => {
e.preventDefault();
uploadArea.classList.add('drag-over');
});

uploadArea.addEventListener('dragleave', () => {
uploadArea.classList.remove('drag-over');
});

uploadArea.addEventListener('drop', (e) => {
e.preventDefault();
uploadArea.classList.remove('drag-over');

if (e.dataTransfer.files.length) {
fileInput.files = e.dataTransfer.files;
handleFileUpload({ target: fileInput });
}
});

console.log('Application initialized successfully');
});
</script>
</body>
</html>
